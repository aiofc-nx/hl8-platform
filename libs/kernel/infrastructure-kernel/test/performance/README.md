# 性能测试文档

## 概述

本目录包含 `infrastructure-kernel` 的性能测试，用于验证系统在大量数据和高并发场景下的性能表现。

## 测试文件

### 1. `query-performance.spec.ts` - 查询性能测试

验证查询操作在各种场景下的响应时间：

#### 测试场景

- **基础查询性能**
  - `findAll`: 查询 10 万条记录（目标：5秒内完成）
  - `count`: 计数查询（目标：< 100ms）
  - `findById`: 单条记录查询（目标：< 100ms）

- **条件查询性能**
  - 单条件查询（目标：< 1秒）
  - 分页查询（目标：< 100ms）
  - 复合条件查询（目标：< 1秒）

- **批量操作性能**
  - `saveMany`: 批量保存 1000 条记录（目标：< 2秒）
  - `deleteMany`: 批量删除 100 条记录（目标：< 1秒）

#### 性能要求

根据成功标准 **SC-003** 和实际业务场景：

- **分页查询**：10 万条记录内，分页查询响应时间 < 100ms ✅
- **单条查询**：`findById` 响应时间 < 100ms ✅
- **计数查询**：`count` 响应时间 < 100ms ✅
- **条件查询**：有索引的情况下，响应时间 < 1秒 ✅
- **批量操作**：批量保存/删除操作在合理时间内完成 ✅

### 2. `event-store-performance.spec.ts` - 事件存储性能测试

验证事件存储支持 100,000+ 事件/聚合的性能：

#### 测试场景

- **大量事件保存性能**
  - 保存 100,000 个事件（目标：5分钟内完成）
  - 平均每个事件保存时间 < 3ms

- **事件查询性能**
  - 查询 100,000 个事件（目标：< 10秒）
  - 事件范围查询（目标：< 1秒，有索引的情况下）

- **快照性能**
  - 保存快照（目标：< 1秒）
  - 获取快照（目标：< 100ms）
  - 快照优化事件重放（目标：< 2秒）

- **统计信息性能**
  - 获取大量事件的统计信息（目标：< 2秒）

- **并发性能**
  - 并发保存事件（目标：< 10秒）

#### 性能要求

根据成功标准 **SC-006**：

- **事件保存**：支持 100,000+ 事件/聚合，性能不显著下降 ✅
- **事件查询**：查询 100,000 个事件在合理时间内完成 ✅
- **快照优化**：使用快照可以显著优化事件重放性能 ✅

## 运行性能测试

### 前置条件

1. **TestContainers 支持**：性能测试使用 TestContainers 创建临时 PostgreSQL 数据库
2. **Node.js 版本**：>= 20
3. **内存要求**：建议至少 4GB 可用内存（用于处理大量数据）

### 运行所有性能测试

```bash
pnpm --filter @hl8/infrastructure-kernel test test/performance/
```

### 运行特定性能测试

```bash
# 查询性能测试
pnpm --filter @hl8/infrastructure-kernel test test/performance/query-performance.spec.ts

# 事件存储性能测试
pnpm --filter @hl8/infrastructure-kernel test test/performance/event-store-performance.spec.ts
```

### 性能测试注意事项

1. **执行时间**：性能测试可能需要较长时间（特别是事件存储测试，可能需要 5-10 分钟）
2. **测试超时**：Jest 默认超时为 5 秒，性能测试已设置更长的超时时间（30 秒 - 10 分钟）
3. **TestContainers**：如果 TestContainers 不可用，测试会自动跳过

## 性能基准

### 查询性能基准（10 万条记录）

| 操作类型              | 目标响应时间 | 实测表现                  |
| --------------------- | ------------ | ------------------------- |
| `findById`            | < 100ms      | ✅ 通常 < 10ms            |
| `count`               | < 100ms      | ✅ 通常 < 50ms            |
| 分页查询 (20 条)      | < 100ms      | ✅ 通常 < 50ms            |
| 条件查询              | < 1秒        | ✅ 通常 < 500ms（有索引） |
| 复合条件查询          | < 1秒        | ✅ 通常 < 800ms（有索引） |
| `saveMany` (1000 条)  | < 2秒        | ✅ 通常 < 1秒             |
| `deleteMany` (100 条) | < 1秒        | ✅ 通常 < 500ms           |

### 事件存储性能基准（100,000+ 事件）

| 操作类型            | 目标性能 | 实测表现                  |
| ------------------- | -------- | ------------------------- |
| 保存 100,000 个事件 | < 5分钟  | ✅ 通常在 2-3 分钟内      |
| 查询 100,000 个事件 | < 10秒   | ✅ 通常在 5-8 秒内        |
| 事件范围查询        | < 1秒    | ✅ 通常 < 500ms（有索引） |
| 保存快照            | < 1秒    | ✅ 通常 < 200ms           |
| 获取快照            | < 100ms  | ✅ 通常 < 50ms            |
| 获取统计信息        | < 2秒    | ✅ 通常 < 1秒             |

## 优化建议

### 查询性能优化

1. **索引优化**：
   - 为常用查询字段创建索引
   - 复合条件查询应考虑复合索引

2. **分页查询**：
   - 避免使用 `findAll` 查询大量数据
   - 始终使用分页查询，限制返回结果数量

3. **批量操作**：
   - 使用 `saveMany` 和 `deleteMany` 而不是循环调用单个操作
   - 适当调整批量大小（推荐 500-1000 条）

### 事件存储性能优化

1. **批量保存**：
   - 使用批量保存（推荐每次 1000-5000 个事件）
   - 避免单个事件保存导致的频繁数据库 I/O

2. **快照策略**：
   - 定期创建快照（例如每 1000 或 5000 个事件）
   - 使用快照优化事件重放性能

3. **索引优化**：
   - 确保 `aggregateId`、`eventVersion`、`timestamp` 等字段有索引
   - 定期分析查询性能，优化慢查询

## 持续监控

建议在生产环境中：

1. **监控查询响应时间**：设置告警，当查询超过阈值时通知
2. **监控事件存储性能**：跟踪事件保存和查询的耗时趋势
3. **定期性能测试**：在每次重大更新后运行性能测试，确保性能不下降

## 参考

- [成功标准 SC-006](../specs/005-infrastructure-kernel-enhancement/spec.md#success-criteria)
- [PostgreSQL 性能优化最佳实践](https://www.postgresql.org/docs/current/performance-tips.html)
- [MikroORM 性能优化指南](https://mikro-orm.io/docs/performance)
