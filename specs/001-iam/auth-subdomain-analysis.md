# 认证子领域分析

**Date**: 2024-12-19  
**Purpose**: 分析是否需要增加认证子领域（Authentication Subdomain）

## 问题提出

当前IAM模块划分为6个子领域：

1. 用户管理子领域
2. 租户管理子领域
3. 组织管理子领域
4. 部门管理子领域
5. 角色管理子领域
6. 权限管理子领域

**问题**：是否应该增加第7个子领域——**认证子领域（Authentication Subdomain）**？

---

## 认证功能范围分析

### 当前规范中的认证相关需求

从`spec.md`中识别出的认证相关功能：

1. **用户登录**（User Story 1）
   - "我是一个已验证的平台用户, **When** 我登录平台"

2. **登录失败锁定**（FR-003, FR-004）
   - 连续5次登录失败后锁定账户
   - 30分钟后自动解锁

3. **账户锁定处理**（Edge Cases）
   - 锁定期间用户无法登录
   - 系统记录锁定时间和原因

4. **密码管理**（FR-002, FR-077）
   - 密码安全要求
   - 密码加密存储

5. **用户状态验证**（FR-009, FR-011）
   - 只有已验证用户才能创建租户
   - 只有活跃用户才能登录

---

## 认证 vs 用户管理：职责边界

### 用户管理子领域（当前）

**职责**：

- 用户注册和账户创建
- 邮箱和手机验证
- 用户信息管理（姓名、邮箱、手机号）
- 用户状态管理（ACTIVE/DISABLED/LOCKED）
- 用户分配关系管理

**关注点**：**用户身份和信息的生命周期管理**

### 认证子领域（建议新增）

**职责**：

- 用户登录认证（密码验证）
- 登录会话管理（Session）
- Token管理（JWT生成、刷新、撤销）
- 登录失败追踪和锁定
- 密码重置流程
- 登出操作
- 多因素认证（MFA，未来扩展）

**关注点**：**身份验证和会话管理**

---

## 为什么需要独立的认证子领域？

### 1. **不同的业务边界**

**用户管理**：

- 聚合根：`PlatformUser`（用户信息）
- 事务边界：用户信息的创建、更新、删除

**认证**：

- 聚合根：`LoginSession`（登录会话）、`AuthenticationToken`（认证令牌）
- 事务边界：登录、登出、token刷新

### 2. **不同的业务规则**

**用户管理规则**：

- 邮箱和手机号必须唯一
- 用户必须先验证才能激活

**认证规则**：

- 登录失败5次后锁定
- Token过期时间管理
- 会话并发控制（同一用户最多N个会话）

### 3. **不同的生命周期**

**用户管理**：

- 用户注册 → 验证 → 激活 → 使用 → 禁用/删除
- 生命周期：长期存在

**认证**：

- 登录 → 创建会话 → 使用 → 登出/过期
- 生命周期：短期存在（几小时到几天）

### 4. **不同的扩展需求**

**用户管理**：

- 扩展点：用户属性、用户分组、用户标签

**认证**：

- 扩展点：OAuth、SSO、MFA、生物识别、密码策略

### 5. **符合DDD原则**

- **单一职责**：认证专注于身份验证，用户管理专注于用户信息
- **高内聚**：认证相关的所有逻辑集中在一个子领域
- **低耦合**：认证依赖用户管理（验证用户存在），但不混合职责

---

## 认证子领域设计建议

### 聚合根设计

#### 1. LoginSession（登录会话聚合根）

**职责**：

- 管理用户登录会话
- 追踪登录失败次数
- 管理会话过期时间

**属性**：

- `sessionId`: EntityId
- `userId`: EntityId（关联PlatformUser）
- `tenantId`: TenantId | null（当前登录的租户）
- `loginAt`: Date
- `lastActivityAt`: Date
- `expiresAt`: Date
- `ipAddress`: string
- `userAgent`: string
- `status`: SessionStatus (ACTIVE/EXPIRED/REVOKED)

**业务规则**：

- 登录失败5次后锁定账户
- 会话30分钟无活动自动过期
- 同一用户最多同时存在5个活跃会话

#### 2. AuthenticationToken（认证令牌聚合根）

**职责**：

- 管理JWT令牌
- 令牌刷新
- 令牌撤销

**属性**：

- `tokenId`: EntityId
- `userId`: EntityId
- `sessionId`: EntityId
- `token`: string（JWT token）
- `refreshToken`: string
- `issuedAt`: Date
- `expiresAt`: Date
- `refreshExpiresAt`: Date
- `revoked`: boolean

**业务规则**：

- Access token 15分钟过期
- Refresh token 7天过期
- 令牌撤销后立即失效

---

## 子领域协作关系

### 认证子领域依赖

```
认证子领域
  ↓ 依赖
用户管理子领域（验证用户存在、获取用户状态）
  ↓ 依赖
租户管理子领域（验证租户状态，决定是否可以登录）
```

### 认证流程

1. **登录请求** → 认证子领域接收
2. **验证用户** → 查询用户管理子领域（用户是否存在、状态是否活跃）
3. **验证密码** → 认证子领域内部验证
4. **创建会话** → 认证子领域创建LoginSession
5. **生成Token** → 认证子领域生成JWT
6. **发布事件** → `UserLoggedInEvent`（供其他子领域订阅）

---

## 与现有架构的集成

### CASL集成

认证子领域与权限管理子领域的协作：

```
用户登录
  ↓
认证子领域创建会话和Token
  ↓
Token中包含用户权限信息
  ↓
权限管理子领域（CASL）验证权限
```

### 事件驱动

认证子领域发布的事件：

- `UserLoggedInEvent` - 用户登录成功
- `UserLoggedOutEvent` - 用户登出
- `LoginFailedEvent` - 登录失败
- `AccountLockedEvent` - 账户被锁定
- `SessionExpiredEvent` - 会话过期
- `TokenRefreshedEvent` - Token刷新

---

## 实施建议

### 阶段1：基础认证（MVP）

- 密码登录
- 会话管理
- JWT token生成
- 登录失败锁定

### 阶段2：增强认证

- Token刷新机制
- 密码重置流程
- 会话并发控制

### 阶段3：高级认证

- 多因素认证（MFA）
- OAuth集成
- SSO支持

---

## 结论

### ✅ **建议增加认证子领域**

**理由**：

1. 认证有独立的业务边界和聚合根
2. 认证与用户管理是不同的关注点
3. 认证有复杂的业务规则（登录失败锁定、会话管理、token管理）
4. 认证有独立的生命周期（短期会话 vs 长期用户信息）
5. 认证需要支持未来扩展（MFA、OAuth、SSO）
6. 符合DDD单一职责和高内聚原则

### 📋 更新后的子领域列表

IAM模块应划分为**7个子领域**：

1. **用户管理子领域**（User Management）- 用户信息和状态管理
2. **认证子领域**（Authentication）- 登录认证和会话管理 ⭐ **新增**
3. **租户管理子领域**（Tenant Management）- 租户生命周期管理
4. **组织管理子领域**（Organization Management）- 组织管理
5. **部门管理子领域**（Department Management）- 部门层级管理
6. **角色管理子领域**（Role Management）- 角色定义和管理
7. **权限管理子领域**（Permission Management）- 权限定义和验证（CASL集成）

---

**分析完成时间**: 2024-12-19  
**建议**: 更新`spec.md`和`plan.md`，增加认证子领域定义
