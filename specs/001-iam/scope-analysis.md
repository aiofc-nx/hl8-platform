# IAM模块范围分析报告

## 📋 分析目标

识别当前规范中不属于IAM（身份与访问管理）核心范畴的需求，为模块划分和职责边界提供参考。

## 🎯 IAM核心职责定义

IAM（Identity and Access Management）的核心职责包括：

1. **身份管理（Identity Management）**
   - 用户注册、认证、账户生命周期管理
   - 用户身份验证（邮箱、手机验证）
   - 用户状态管理（激活、禁用、锁定）

2. **访问控制（Access Control）**
   - 权限定义和管理
   - 角色定义和管理
   - 权限分配和验证
   - 用户授权决策

3. **多租户基础**
   - 租户数据隔离实现
   - 租户上下文管理
   - 跨租户访问控制

4. **用户分配**
   - 用户与租户/组织/部门的关联关系管理
   - 用户分配的业务规则验证

## ⚠️ 超出IAM范畴的需求识别

### 类别1：订阅/计费管理（Billing & Subscription Management）

这些需求属于计费和订阅管理模块的核心职责：

| FR编号 | 需求描述 | 建议归属模块 | 理由 |
|--------|---------|------------|------|
| **FR-017** | 创建新租户时默认类型为FREE | 订阅管理模块 | 租户类型和计费计划属于订阅管理 |
| **FR-049** | 根据租户类型限制用户数量 | 订阅/配额管理模块 | 配额限制是订阅计划的一部分 |
| **FR-055** | 根据租户类型强制执行资源限制 | 订阅/配额管理模块 | 资源配额是计费模型的核心 |
| **FR-056** | 防止资源配置超出租户类型限制 | 订阅/配额管理模块 | 同上 |
| **FR-057** | 资源使用达到80%时发送警告 | 配额监控模块 | 配额监控和告警 |
| **FR-058** | 阻止超出资源限制的操作 | 配额管理模块 | 配额执行 |
| **FR-059** | 提供升级建议 | 订阅/营销模块 | 升级建议属于营销和订阅管理 |
| **FR-068** | 设置默认试用期30天 | 订阅管理模块 | 试用期是订阅计划的一部分 |
| **FR-069** | 从租户创建时间计算试用期 | 订阅管理模块 | 试用期计算逻辑 |
| **FR-070** | 发送试用期到期提醒 | 订阅/通知模块 | 订阅生命周期通知 |
| **FR-071** | 提供7天宽限期 | 订阅管理模块 | 宽限期是订阅策略 |
| **FR-072** | 试用期到期自动转为EXPIRED | 订阅管理模块 | 订阅状态转换 |
| **FR-026** | 试用期到期自动转换状态 | 订阅管理模块 | 同上 |

**影响范围**：

- 租户状态管理（FR-024）中的部分转换逻辑（TRIAL→ACTIVE, TRIAL→EXPIRED）应属于订阅管理
- 用户故事2中的"提供升级选项"属于订阅管理

---

### 类别2：组织结构管理（Organization Structure Management）

这些需求属于独立的组织结构管理模块：

| FR编号 | 需求描述 | 建议归属模块 | 理由 |
|--------|---------|------------|------|
| **FR-031** | 根据租户类型限制组织数量 | 组织结构管理模块 | 组织CRUD管理 |
| **FR-032** | 防止删除默认组织 | 组织结构管理模块 | 组织生命周期管理 |
| **FR-033** | 确保组织名称在租户内唯一 | 组织结构管理模块 | 组织业务规则 |
| **FR-034** | 创建组织时自动创建根部门 | 组织结构管理模块 | 组织结构初始化 |
| **FR-035** | 防止删除根部门 | 组织结构管理模块 | 部门生命周期管理 |
| **FR-036** | 防止删除包含部门的组织 | 组织结构管理模块 | 组织依赖关系管理 |
| **FR-037** | 支持无限部门创建 | 组织结构管理模块 | 部门CRUD管理 |
| **FR-038** | 支持多层级部门嵌套（8层） | 组织结构管理模块 | 部门层级结构管理 |
| **FR-039** | 允许平台管理员调整部门层级限制 | 组织结构管理模块 | 组织配置管理 |
| **FR-040** | 强制部门层级限制 | 组织结构管理模块 | 部门层级验证 |
| **FR-041** | 确保部门名称在组织内唯一 | 组织结构管理模块 | 部门业务规则 |
| **FR-042** | 提供友好的层级限制错误消息 | 组织结构管理模块 | 用户体验 |
| **FR-043** | 维护部门层级关系 | 组织结构管理模块 | 部门关系管理 |
| **FR-019** | 创建租户时自动创建默认组织 | 组织结构管理模块 | 组织初始化（IAM触发） |
| **FR-020** | 创建租户时自动创建根部门 | 组织结构管理模块 | 部门初始化（IAM触发） |

**说明**：

- 虽然组织和部门的创建由IAM触发（作为租户初始化的部分），但组织和部门的CRUD管理、业务规则、层级结构管理本身属于独立的组织结构管理模块
- IAM模块只负责：验证组织/部门的存在、管理用户与组织/部门的分配关系

**用户故事影响**：

- User Story 4（组织创建和管理）- 完全属于组织结构管理模块
- User Story 5（部门结构管理）- 完全属于组织结构管理模块

---

### 类别3：内容审核/合规（Content Review & Compliance）

| FR编号 | 需求描述 | 建议归属模块 | 理由 |
|--------|---------|------------|------|
| **FR-061** | 租户名称变更需要审核流程 | 内容审核模块 | 内容审核工作流 |
| **FR-062** | 确保租户名称唯一性 | IAM模块 ✓ | 唯一性验证是IAM职责 |
| **FR-063** | 自动审核租户名称变更 | 内容审核模块 | 自动审核逻辑 |
| **FR-064** | 支持手动审核 | 内容审核模块 | 人工审核工作流 |
| **FR-065** | 24小时内完成审核 | 内容审核模块 | 审核时效性 |
| **FR-066** | 拒绝非法/禁止内容 | 内容审核模块 | 内容合规检查 |
| **FR-067** | 提供名称建议 | 内容审核模块 | 审核辅助功能 |

**说明**：

- FR-062（唯一性验证）属于IAM，因为它涉及租户标识符的唯一性约束
- 其他审核相关的功能属于内容审核模块

---

### 类别4：通知系统实现（Notification Infrastructure）

虽然IAM需要触发通知，但通知系统的具体实现细节不属于IAM：

| FR编号 | 需求描述 | 建议归属模块 | 理由 |
|--------|---------|------------|------|
| **FR-006** | 邮件/SMS服务重试（最多3次，指数退避） | 通知基础设施模块 | 通知服务的可靠性实现 |
| **FR-007** | 外部服务失败降级处理 | 通知基础设施模块 | 通知服务的容错机制 |
| **FR-050** | 发送邀请通知 | 通知基础设施模块 | 通知发送实现 |
| **FR-053** | 发送提醒通知 | 通知基础设施模块 | 通知发送实现 |

**说明**：

- IAM的职责是：触发通知、传递通知内容和接收者信息
- 通知基础设施的职责是：通知发送、重试、降级、多渠道支持等

---

### 类别5：租户标识符管理（边界情况）

部分租户标识符管理可能更偏向独立的租户管理模块：

| FR编号 | 需求描述 | 建议归属模块 | 理由 |
|--------|---------|------------|------|
| **FR-013** | 确保租户代码唯一性 | IAM模块 ✓ | 租户标识符管理是IAM职责 |
| **FR-014** | 确保租户域名唯一性 | 租户管理模块 | 域名管理更偏向租户配置 |
| **FR-015** | 验证租户代码格式 | IAM模块 ✓ | 标识符格式验证 |
| **FR-016** | 验证租户域名格式 | 租户管理模块 | 域名格式验证 |

**说明**：

- 租户代码（Tenant Code）作为租户的唯一标识符，其唯一性管理属于IAM
- 租户域名作为租户的访问配置，可能更偏向租户管理或基础设施配置模块

---

### 类别6：审计日志存储（Audit Logging Storage）

| FR编号 | 需求描述 | 建议归属模块 | 理由 |
|--------|---------|------------|------|
| **FR-078到FR-082** | 审计日志记录 | IAM模块 ✓ | IAM负责记录审计事件 |
| 审计日志的存储、查询、分析 | - | 审计日志模块 | 日志基础设施和查询 |

**说明**：

- IAM负责**生成**审计日志事件
- 审计日志模块负责**存储、查询、分析**审计日志

---

## 📊 统计总结

### 需求分类统计

| 类别 | 需求数量 | 百分比 |
|------|---------|--------|
| **IAM核心需求** | ~45 | ~55% |
| **订阅/计费管理** | 13 | 16% |
| **组织结构管理** | 15 | 18% |
| **内容审核** | 6 | 7% |
| **通知系统实现** | 4 | 5% |
| **边界情况** | ~2 | ~2% |

### 用户故事归属

| 用户故事 | 当前归属 | 建议调整 |
|---------|---------|---------|
| User Story 1（用户注册） | IAM ✓ | 保持 |
| User Story 2（租户创建） | IAM | 部分属于订阅管理（租户类型、试用期） |
| User Story 3（用户邀请） | IAM ✓ | 保持 |
| User Story 4（组织管理） | IAM | 移动到组织结构管理模块 |
| User Story 5（部门管理） | IAM | 移动到组织结构管理模块 |
| User Story 6（租户状态管理） | IAM | 部分属于订阅管理（状态转换逻辑） |

---

## 🔄 建议的模块划分

### 方案A：保持IAM模块，但明确职责边界（推荐）

**优点**：

- 最小化代码重构
- 保持业务连续性
- 通过接口解耦

**实施**：

1. IAM模块保留所有需求，但通过领域事件和接口与外部模块协作
2. 订阅管理模块：订阅计划、配额管理、试用期管理
3. 组织结构管理模块：组织/部门的CRUD和业务规则
4. 内容审核模块：租户名称审核工作流
5. IAM模块通过接口调用这些模块，而非直接实现

### 方案B：严格分离模块职责

**优点**：

- 职责清晰
- 高内聚低耦合
- 便于独立演进

**缺点**：

- 需要重构现有设计
- 增加模块间协调复杂度

---

## ✅ 建议

1. **短期（当前阶段）**：采用方案A，保持IAM模块包含所有需求，但通过接口和事件驱动架构与其他模块协作

2. **中期（演进阶段）**：
   - 将订阅管理相关逻辑抽取为独立的订阅管理模块
   - 将组织结构管理抽取为独立的组织结构管理模块
   - IAM模块通过领域事件和接口与这些模块协作

3. **文档更新**：
   - 在规范中明确标注每个需求的"直接实现模块"和"协作模块"
   - 在"Out of Scope"部分明确说明某些功能的实现细节属于其他模块

---

## 📝 下一步行动

1. ✅ 已完成：识别超出IAM范畴的需求
2. ⏳ 待定：决定采用方案A还是方案B
3. ⏳ 待定：更新规范文档，明确模块职责边界
4. ⏳ 待定：设计模块间协作接口（如采用方案A）

---

---

## ✅ 明确结论：应由其他业务模块实现

### 答案：是的，这些需求应该由其他独立的业务模块来实现

根据DDD原则和模块化架构设计，以下需求应该分配给独立的业务模块：

### 1. 订阅管理模块 (Subscription Management Module)

**应实现的需求**：FR-017, FR-026, FR-049, FR-055~FR-059, FR-068~FR-072

**核心职责**：

- 订阅计划和租户类型管理
- 试用期管理和状态转换（TRIAL→ACTIVE, TRIAL→EXPIRED）
- 资源配额管理和监控
- 升级建议和营销

**与IAM协作**：

- IAM发布 `TenantCreated` 事件 → 订阅模块初始化订阅计划
- IAM查询订阅模块接口获取配额信息
- 订阅模块发布 `QuotaExceeded` 事件 → IAM阻止操作

---

### 2. 组织结构管理模块 (Organization Structure Management Module)

**应实现的需求**：FR-019, FR-020, FR-031~FR-043

**核心职责**：

- 组织和部门的完整生命周期管理（CRUD）
- 组织层级结构管理
- 部门和组织的业务规则验证

**与IAM协作**：

- IAM发布 `TenantCreated` 事件 → 组织结构模块创建默认组织和根部门
- IAM查询组织结构模块验证组织/部门存在性
- IAM管理用户与组织/部门的分配关系（这是IAM的核心职责）

**用户故事归属**：

- User Story 4（组织创建和管理）→ **组织结构管理模块**
- User Story 5（部门结构管理）→ **组织结构管理模块**

---

### 3. 内容审核模块 (Content Review Module)

**应实现的需求**：FR-061, FR-063~FR-067

**核心职责**：

- 租户名称审核工作流
- 自动和人工审核流程
- 内容合规性检查

**与IAM协作**：

- IAM发布 `TenantNameChangeRequested` 事件
- 内容审核模块执行审核，发布审核结果事件
- IAM订阅审核结果更新租户名称

---

### 4. 通知基础设施模块 (Notification Infrastructure Module)

**应实现的需求**：FR-006, FR-007, FR-050, FR-053（实现细节）

**核心职责**：

- 多渠道通知发送（邮件、短信、推送）
- 通知重试和降级策略
- 通知模板管理

**与IAM协作**：

- IAM发布通知请求事件（如 `VerificationCodeRequested`、`UserInvitationNotificationRequested`）
- 通知模块订阅事件并执行实际发送逻辑

**说明**：IAM负责**触发**通知，通知模块负责**发送**通知

---

### 5. 审计日志模块 (Audit Logging Module) - 基础设施层

**职责划分**：

- **IAM模块**：生成审计事件（FR-078~FR-082）
- **审计日志模块**：存储、查询、分析审计日志

---

## 📐 模块协作架构建议

### 事件驱动协作模式

```
IAM模块（身份与访问管理）
  │
  ├─ TenantCreated 事件
  │   ├─→ 订阅管理模块：初始化订阅计划
  │   └─→ 组织结构模块：创建默认组织和部门
  │
  ├─ UserInvited 事件
  │   ├─→ 订阅管理模块：检查用户数配额
  │   └─→ 通知模块：发送邀请通知
  │
  ├─ 查询接口调用
  │   ├─ getTenantQuota() → 订阅管理模块
  │   └─ validateOrganizationExists() → 组织结构模块
  │
  └─ 订阅的事件
      ├─ QuotaExceeded ← 订阅管理模块
      ├─ TenantNameApproved ← 内容审核模块
      └─ NotificationSent ← 通知模块
```

---

## 🎯 实施建议

### 阶段1：IAM模块开发（当前阶段）

**策略**：

- IAM模块实现所有IAM核心需求
- 对于超出范畴的需求：
  1. **保留在规范中**，但明确标注"由XX模块实现"
  2. **通过领域事件触发**其他模块
  3. **通过接口查询**其他模块（如其他模块未实现，提供Mock实现）

### 阶段2：模块拆分（后续迭代）

**优先级**：

1. **订阅管理模块**（P1）- 核心业务功能
2. **组织结构管理模块**（P2）- 独立业务领域
3. **内容审核模块**（P3）- 可延后
4. **通知基础设施模块**（P0）- 平台级基础设施

### 阶段3：规范更新

**需要更新**：

1. 在 `spec.md` 中为每个需求标注实现模块
2. 新增"模块协作说明"章节
3. 在"Out of Scope"中明确各模块职责边界

---

**报告生成时间**：2024-12-19  
**分析范围**：specs/001-iam/spec.md 中的所有功能需求（FR-001至FR-082）  
**结论**：约45%的需求应由其他业务模块实现，IAM模块通过事件驱动和接口调用与其他模块协作
